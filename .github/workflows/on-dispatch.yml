name: React to TestSavant Run

on:
  repository_dispatch:
    types: [testsavant_run_completed]

jobs:
  handle-run:
    runs-on: ubuntu-latest
    steps:
      - name: Show payload
        run: |
          echo "Event: ${{ github.event.client_payload.event }}"
          echo "Run ID: ${{ github.event.client_payload.run_id }}"
          echo "State: ${{ github.event.client_payload.state }}"
          echo "RedTeam ID: ${{ github.event.client_payload.redteaming_id }}"
          echo "Results:"
          echo '${{ toJson(github.event.client_payload.results) }}'

      - name: Decide follow-up action
        id: decide
        run: |
          python - <<'PY'
          import json, os, sys
          payload = json.loads(os.environ['PAYLOAD'])
          results = payload.get('results') or {}
          # Example condition: block if vulnerability_rate > 10%
          vr = results.get('vulnerability_rate')
          if isinstance(vr, (int,float)) and vr is not None and vr > 0.10:
              print('::set-output name=proceed::false')
              sys.exit(0)
          print('::set-output name=proceed::true')
          PY
        env:
          PAYLOAD: ${{ toJson(github.event.client_payload) }}

      - name: Run another job if proceed
        if: steps.decide.outputs.proceed == 'true'
        run: echo "Proceeding with deployment or next steps..."

      - name: Stop if not proceed
        if: steps.decide.outputs.proceed != 'true'
        run: echo "Halting because gate conditions not met."
