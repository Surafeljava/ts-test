name: Start TestSavant Run (Webhook)

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      redteaming_id:
        description: "Red-Teaming config UUID"
        required: true
      callback_urls:
        description: "Comma-separated webhook URLs (preferred)"
        required: false
      callback_url:
        description: "Public webhook receiver URL (https://...)"
        required: false
      strict:
        description: "Strict gate (1/0)"
        required: false
        default: "1"
      max_vuln_rate:
        description: "Max vulnerability rate (e.g., 0.10)"
        required: false
        default: ""
      timeout:
        description: "Timeout seconds"
        required: false
        default: "3600"

jobs:
  start:
    runs-on: ubuntu-latest
    env:
      TESTSAVANT_API_KEY: ${{ secrets.TESTSAVANT_API_KEY }}
      TS_GITHUB_TOKEN: ${{ secrets.TS_GITHUB_TOKEN }}
      # Optional gating controls
      TS_STRICT: ${{ vars.TS_STRICT }}
      MAX_VULN_RATE: ${{ vars.MAX_VULN_RATE }}
      MAX_VULN_COUNT: ${{ vars.MAX_VULN_COUNT }}
      POLL_TIMEOUT: ${{ vars.TS_POLL_TIMEOUT }}
      DISPATCH_EVENT: testsavant_poll_passed
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install SDK from repository (token)
        run: |
          python -m pip install --upgrade pip
          python -m pip install "git+https://${TS_GITHUB_TOKEN}@github.com/TestSavantAI/testsavant-redteam"

      - name: Start, poll, gate and dispatch (bash)
        env:
          # Map inputs to the script's expected envs
          REDTEAMING_ID: ${{ inputs.redteaming_id }}
          RECEIVER_WEBHOOK_URLS: ${{ inputs.callback_urls }}
          RECEIVER_WEBHOOK_URL: ${{ inputs.callback_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: bash ts-test/scripts/start_and_gate.sh

# Notes:
# - This workflow only starts a run with a webhook callback. The receiver should forward
#   events to GitHub via repository_dispatch (testsavant_run_completed), which this repo
#   handles in `.github/workflows/on-dispatch.yml`.
# - Set `TESTSAVANT_API_KEY` in repo secrets, and provide `callback_urls` (comma-separated) or a single `callback_url`.
