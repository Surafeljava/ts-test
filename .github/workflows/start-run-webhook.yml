name: Start TestSavant Run (Webhook)

on:
  workflow_dispatch:
    inputs:
      redteaming_id:
        description: "Red-Teaming config UUID"
        required: true
      callback_urls:
        description: "Comma-separated webhook URLs (preferred)"
        required: false
      callback_url:
        description: "Public webhook receiver URL (https://...)"
        required: false
      strict:
        description: "Strict gate (1/0)"
        required: false
        default: "1"
      max_vuln_rate:
        description: "Max vulnerability rate (e.g., 0.10)"
        required: false
        default: ""
      timeout:
        description: "Timeout seconds"
        required: false
        default: "3600"

jobs:
  start:
    runs-on: ubuntu-latest
    env:
      TESTSAVANT_API_KEY: ${{ secrets.TESTSAVANT_API_KEY }}
      TS_GITHUB_TOKEN: ${{ secrets.TS_GITHUB_TOKEN }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install SDK from repository (token)
        run: |
          python -m pip install --upgrade pip
          python -m pip install "git+https://${TS_GITHUB_TOKEN}@github.com/TestSavantAI/testsavant-redteam@main#subdirectory=sdk"

      - name: Start run via webhook callback
        run: |
          python - <<'PY'
          import os, sys, json
          from testsavant_redteaming.client import TestSavantClient
          api_key = os.environ.get('TESTSAVANT_API_KEY')
          if not api_key:
            print('Missing TESTSAVANT_API_KEY secret', file=sys.stderr)
            sys.exit(2)
          red_id = '${{ inputs.redteaming_id }}'
          cb_urls = '${{ inputs.callback_urls }}'.strip()
          cb_url = '${{ inputs.callback_url }}'.strip()
          callback_urls = cb_urls or cb_url
          if not callback_urls:
            print('Provide callback_urls (preferred) or callback_url', file=sys.stderr)
            sys.exit(2)
          client = TestSavantClient(api_key=api_key)
          run_id = client.create_run(red_id, callback_urls=callback_urls, callback_events='run.completed,run.failed')
          print(json.dumps({'run_id': run_id}))
          PY

# Notes:
# - This workflow only starts a run with a webhook callback. The receiver should forward
#   events to GitHub via repository_dispatch (testsavant_run_completed), which this repo
#   handles in `.github/workflows/on-dispatch.yml`.
# - Set `TESTSAVANT_API_KEY` in repo secrets, and provide `callback_urls` (comma-separated) or a single `callback_url`.
