name: Start TestSavant Run on Push

on:
  push:
    branches: [main]

jobs:
  start:
    runs-on: ubuntu-latest
    env:
      TESTSAVANT_API_KEY: ${{ secrets.TESTSAVANT_API_KEY }}
      REDTEAMING_ID: ${{ vars.REDTEAMING_ID }}
      RECEIVER_WEBHOOK_URL: ${{ secrets.RECEIVER_WEBHOOK_URL }}
      TESTSAVANT_BASE_URL: ${{ vars.TESTSAVANT_BASE_URL }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install SDK
        run: |
          python -m pip install --upgrade pip
          pip install testsavant-redteam

      - name: Start run via webhook callback
        run: |
          python - <<'PY'
          import os, sys, json
          from testsavant_redteaming.client import TestSavantClient

          api_key = os.environ.get('TESTSAVANT_API_KEY')
          red_id = os.environ.get('REDTEAMING_ID')
          cb_url = os.environ.get('RECEIVER_WEBHOOK_URL')
          base_url = os.environ.get('TESTSAVANT_BASE_URL')

          missing = [k for k,v in [('TESTSAVANT_API_KEY', api_key), ('REDTEAMING_ID', red_id), ('RECEIVER_WEBHOOK_URL', cb_url)] if not v]
          if missing:
            print(f"Missing required envs: {', '.join(missing)}", file=sys.stderr)
            sys.exit(2)

          client = TestSavantClient(api_key=api_key, base_url=base_url)
          run_id = client.create_run(red_id, callback_url=cb_url, callback_events='run.completed,run.failed')
          print(json.dumps({'run_id': run_id}))
          PY

# Notes:
# - Set repo secret `TESTSAVANT_API_KEY` and `RECEIVER_WEBHOOK_URL` (public HTTPS).
# - Set repo variable `REDTEAMING_ID` (UUID). Optionally set `TESTSAVANT_BASE_URL`.
# - Your webhook receiver should trigger `repository_dispatch` on final events, which
#   this repo handles in `.github/workflows/on-dispatch.yml`.
