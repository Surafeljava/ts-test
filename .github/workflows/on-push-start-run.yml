name: Start TestSavant Run on Push

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  start:
    runs-on: ubuntu-latest
    env:
      TESTSAVANT_API_KEY: ${{ secrets.TESTSAVANT_API_KEY }}
      REDTEAMING_ID: ${{ vars.REDTEAMING_ID }}
      RECEIVER_WEBHOOK_URLS: ${{ secrets.RECEIVER_WEBHOOK_URLS }}
      RECEIVER_WEBHOOK_URL: ${{ secrets.RECEIVER_WEBHOOK_URL }}
      TS_GITHUB_TOKEN: ${{ secrets.TS_GITHUB_TOKEN }}
      # Optional gating controls
      TS_STRICT: ${{ vars.TS_STRICT }}
      MAX_VULN_RATE: ${{ vars.MAX_VULN_RATE }}
      MAX_VULN_COUNT: ${{ vars.MAX_VULN_COUNT }}
      POLL_TIMEOUT: ${{ vars.TS_POLL_TIMEOUT }}
      DISPATCH_EVENT: testsavant_poll_passed
    steps:
      - uses: actions/checkout@v4

      - name: Start, poll, gate and dispatch (bash)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: bash scripts/start_and_gate.sh
          PY

      - name: Proceeding...
        if: steps.poll_and_gate.outputs.proceed == 'true'
        run: echo "Proceeding with next steps (dispatched testsavant_poll_passed)."

      - name: Halting due to gate
        if: steps.poll_and_gate.outputs.proceed != 'true'
        run: echo "Halting because gate conditions not met."

# Notes:
# - Set repo secret `TESTSAVANT_API_KEY` and either `RECEIVER_WEBHOOK_URLS` (comma-separated) or `RECEIVER_WEBHOOK_URL` (single) pointing to public HTTPS receivers.
# - Set repo variable `REDTEAMING_ID` (UUID). Optionally set `TESTSAVANT_BASE_URL`.
# - Your webhook receiver should trigger `repository_dispatch` on final events, which
#   this repo handles in `.github/workflows/on-dispatch.yml`.

