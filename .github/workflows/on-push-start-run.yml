name: Start TestSavant Run on Push

on:
  push:
    branches: [main]

jobs:
  start:
    runs-on: ubuntu-latest
    env:
      TESTSAVANT_API_KEY: ${{ secrets.TESTSAVANT_API_KEY }}
      REDTEAMING_ID: ${{ vars.REDTEAMING_ID }}
      RECEIVER_WEBHOOK_URLS: ${{ secrets.RECEIVER_WEBHOOK_URLS }}
      RECEIVER_WEBHOOK_URL: ${{ secrets.RECEIVER_WEBHOOK_URL }}
      TS_GITHUB_TOKEN: ${{ secrets.TS_GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install SDK from repository (token)
        run: |
          python -m pip install --upgrade pip
          python -m pip install "git+https://${TS_GITHUB_TOKEN}@github.com/TestSavantAI/testsavant-redteam@main#subdirectory=sdk"

      - name: Start run via multiple webhook callbacks
        run: |
          python - <<'PY'
          import os, sys, json
          from testsavant_redteaming.client import TestSavantClient

          api_key = os.environ.get('TESTSAVANT_API_KEY')
          red_id = os.environ.get('REDTEAMING_ID')
          cb_urls = os.environ.get('RECEIVER_WEBHOOK_URLS') or ''
          cb_url = os.environ.get('RECEIVER_WEBHOOK_URL') or ''
          # Prefer list env; fallback to single
          callback_urls = cb_urls.strip() or cb_url.strip()

          missing = [k for k,v in [('TESTSAVANT_API_KEY', api_key), ('REDTEAMING_ID', red_id)] if not v]
          if not callback_urls:
            missing.append('RECEIVER_WEBHOOK_URLS or RECEIVER_WEBHOOK_URL')
          if missing:
            print(f"Missing required envs: {', '.join(missing)}", file=sys.stderr)
            sys.exit(2)

          client = TestSavantClient(api_key=api_key)
          run_id = client.create_run(red_id, callback_urls=callback_urls, callback_events='run.completed,run.failed')
          print(json.dumps({'run_id': run_id}))
          PY

# Notes:
# - Set repo secret `TESTSAVANT_API_KEY` and either `RECEIVER_WEBHOOK_URLS` (comma-separated) or `RECEIVER_WEBHOOK_URL` (single) pointing to public HTTPS receivers.
# - Set repo variable `REDTEAMING_ID` (UUID). Optionally set `TESTSAVANT_BASE_URL`.
# - Your webhook receiver should trigger `repository_dispatch` on final events, which
#   this repo handles in `.github/workflows/on-dispatch.yml`.
